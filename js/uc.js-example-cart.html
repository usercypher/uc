<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ElX â€“ Example Usage</title>
  <script src="uc.js" defer></script>
  <style>


  </style>
</head>
<body style="padding: 1em;">
    
    <table width='100%'>
        <thead>
            <tr>
                <th width='25%'>Category</th>
                <th width='25%'>Product</th>
                <th class='price' width='15%'>Price</th>
                <th class='quantity' width='10%'>Quantity</th>
                <th class='price' width='15%'>Subtotal</th>
                <th width='10%'> </th>
            </tr>
        </thead>
        <tbody id="lines">
            
        </tbody>
    </table>
    <p>
        Total value: <span x-ref-grandtotal>0.00</span>
    </p>
    <button x-on-click x-var-addline>Add product</button>
    <button x-on-click x-var-save>Submit order</button>

    <script type="text/html" id="line-html">
        <tr id="line-:id">
            <td>
                <select 
                    x-ref-category-:id
                    x-on-input
                    x-var-category-:id="this"
                >:category</select>
            </td>
            <td>
                <select 
                    x-ref-product-:id
                    x-on-input
                    x-var-product-:id="this"
                >:product</select>
            </td>
            <td>
                <span x-ref-price-:id>:price</span>
            </td>
            <td>
                <input
                    type="number"
                    x-ref-qty-:id
                    x-on-input
                    x-var-qty-:id="this"
                    value=":qty"
                />
            </td>
            <td>
                <span x-ref-subtotal-:id>:subtotal</span>
            </td>
            <td>
                <a x-on-click x-prevent x-var-removeline=":id">Remove</a>
            </td>
        </tr>
    </script>

    <script type="text/html" id="option-html">
        <option value=":value">
            :value
        </option>
    </script>

    <!-- Load Script -->
<script>
(window.init = window.init || []).push(function () {
    ElX.init(document.getElementsByTagName("*"), "tabfirst:tablast");
     
    function ProductModel(id, name, category, qty, price) {
        this.id = id;
        this.name = ElX.x("product-" + id, name);
        this.category = ElX.x("category-" + id, category);
        this.qty = ElX.x("qty-" + id, qty);
        this.price = ElX.x("price-" + id, price);
        this.subtotal = ElX.x("subtotal-" + id, qty * price);

        this.qty.tap(ProductModel.prototype.subtotalCalc, this);
        this.price.tap(ProductModel.prototype.subtotalCalc, this);
    }    
    ProductModel.prototype.subtotalCalc = function () {
        this.subtotal.var(this.price.value() * this.qty.value());
    };
    
    function Category() {
        this.tpl = document.getElementById("option-html").innerHTML;
        this.options = ["Cars", "Planes"];
    }
    Category.prototype.yield = function () {
        var output = "";
        var that = this;
        this.options.forEach(function (opt) {
            output += Utils.strReplace(that.tpl, { ":value": opt });
        });
        return output;
    };

    function Product(product) {
        this.product = product;
        this.tpl = document.getElementById("option-html").innerHTML;
        this.options = [
            {name: "1948 Porsche 356-A Roadster", category: "Cars", price: 53.90},
            {name: "1948 Porsche Type 356 Roadster", category: "Cars", price: 62.16},
            {name: "1900s Vintage Bi-Plane", category: "Planes", price: 34.25},
            {name: "1900s Vintage Tri-Plane", category: "Planes", price: 36.23}
        ];

        product.price.tap(Product.prototype.priceVal, this);
        product.name.tap(Product.prototype.updatePrice, this);
        product.category.tap(Product.prototype.updateName, this);
    }
    Product.prototype.priceVal = function (old, current) {
        this.product.price.val(current.toFixed(2));
    };
    Product.prototype.updatePrice = function (old, current) {
        var that = this;
        this.options.forEach(function (opt) {
            if (opt.name === current) that.product.price.var(opt.price);
        });
    };
    Product.prototype.updateName = function (old, current) {
        var that = this;
        var found = false;
        this.options.forEach(function (opt) {
            if (!found && opt.category === current) {
                that.product.name.var(opt.name);
                that.product.name.ref().forEach(function (el) {
                    el.innerHTML = that.yield();
                });
                found = true;
            }
        });
    };
    Product.prototype.yield = function () {
        var output = "";
        var that = this;
        this.options.forEach(function (opt) {
            if (opt.category === that.product.category.value()) {
                output += Utils.strReplace(that.tpl, { ":value": opt.name });
            }
        });
        return output;
    };

    function Line(product) {
        this.product = product;
        this.categoryComponent = new Category();
        this.productComponent = new Product(product);
        this.tpl = document.getElementById("line-html").innerHTML;

        this.product.subtotal.tap(Line.prototype.subtotalVal, this);
    }
    Line.prototype.init = function () {
        this.ui = new El("line-" + this.product.id);
    };
    Line.prototype.subtotalVal = function (old, current) {
        this.product.subtotal.val(current.toFixed(2));
    };
    Line.prototype.yield = function () {
        return Utils.strReplace(this.tpl, {
            ":category": this.categoryComponent.yield(),
            ":product": this.productComponent.yield(),
            ":id": this.product.id,
            ":price": this.product.price.value().toFixed(2),
            ":qty": this.product.qty.value(),
            ":subtotal": this.product.subtotal.value().toFixed(2)
        });
    };

    function Cart() {
        this.lines = {};
        this.id = 0;
        this.ui = new El("lines");
        this.grandtotal = ElX.x("grandtotal");

        this.grandtotal.tap(Cart.prototype.grandtotalVal, this);

        ElX.tap("addline", Cart.prototype.addline, this);
        ElX.tap("removeline", Cart.prototype.removeline, this);
        ElX.tap("save", Cart.prototype.save, this);
    }
    Cart.prototype.addline = function () {
        var product = new ProductModel(this.id, "1948 Porsche 356-A Roadster", "Cars", 1, 53.90);

        product.subtotal.tap(Cart.prototype.grandtotalCalc, this);

        var line = new Line(product);

        this.lines[this.id] = line;
        this.ui.append(line.yield());

        line.init();
        ElX.init(this.ui.el.getElementsByTagName("*"));

        this.grandtotalCalc();
        this.id++;
    };
    Cart.prototype.removeline = function (old, current) {
        var id = Number(current);
        this.lines[id].ui.remove();
        delete this.lines[id];
        ElX.clean();
        this.grandtotalCalc();
    };
    Cart.prototype.save = function () {
        var products = [];
        for (var key in this.lines) {
            if (!this.lines.hasOwnProperty(key)) continue;
            products.push({
                productName: this.lines[key].product.name.value(),
                quantity: this.lines[key].product.qty.value()
            });
        }
        alert(JSON.stringify(products));
    };
    Cart.prototype.grandtotalVal = function (old, current) {
        this.grandtotal.val(current.toFixed(2));
    };
    Cart.prototype.grandtotalCalc = function () {
        var grandtotal = 0;
        for (var key in this.lines) {
            if (!this.lines.hasOwnProperty(key)) continue;
            grandtotal += this.lines[key].product.subtotal.value();
        }
        this.grandtotal.var(grandtotal);
    };

    new Cart();
    
});
</script>

</body>
</html>
